---
- hosts: localhost
  
  vars:
    HOME_DIR: "{{lookup('env', 'HOME')}}"
    BASHRC: "{{HOME_DIR}}/.bashrc"
    CONFIG_FISH: "{{HOME_DIR}}/.config/fish/config.fish"
  
  tasks:
  
    # for bash
    - name: Get status .bashrc
      stat: path={{BASHRC}}
      register: bashrc

    - name: Add 'CONSCRIPT_HOME' to .bashrc
      lineinfile:
        dest={{BASHRC}}
        line='export CONSCRIPT_HOME=$HOME/.conscript/'
        regexp='^export CONSCRIPT_HOME'
      when: bashrc.stat.exists  
    
    - name: Append 'PATH' to .bashrc
      lineinfile:
        dest={{BASHRC}}
        line='export PATH=$CONSCRIPT_HOME/bin:$PATH'
        regexp='^export PATH=\$CONSCRIPT_HOME/bin'
      when: bashrc.stat.exists

    # for fish
    - name: Get status config.fish
      stat: path={{CONFIG_FISH}}
      register: config_fish

    - name: Add 'CONSCRIPT_HOME' to config.fish
      lineinfile:
        dest={{CONFIG_FISH}}
        line='set -x CONSCRIPT_HOME $HOME/.conscript'
        regexp='^set -x CONSCRIPT_HOME'
      when: config_fish.stat.exists

    - name: Append 'PATH' to config.fish
      lineinfile:
        dest={{CONFIG_FISH}}
        line='set -x PATH $CONSCRIPT_HOME/bin $PATH'
        regexp='^set -x PATH \$CONSCRIPT_HOME/bin'
      when: config_fish.stat.exists

    # Install conscript
    - name: which conscript
      command: 'which cs'
      register: which_cs
      ignore_errors: yes
  
    - name: Get setup script
      get_url:
        url: https://raw.githubusercontent.com/foundweekends/conscript/master/setup.sh
        dest: /tmp/setup.sh
        force: yes
        mode: u+x
      when: which_cs|failed

    - name: Install conscript
      shell: /tmp/setup.sh
      when: which_cs|failed
      ignore_errors: yes

